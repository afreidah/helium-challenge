# -----------------------------------------------------------------------------
# CI/CD WORKFLOW
# -----------------------------------------------------------------------------
# Pull Request: Run CI checks (format, validate, test, plan, cost)
# Merge to main: Same as PR, then WAIT FOR APPROVAL before apply
#
# SETUP REQUIRED REVIEWERS:
#   1. Go to repo Settings ‚Üí Environments
#   2. Create environment named "production"
#   3. Add required reviewers (at least 1)
#   4. Save - apply job will now wait for approval before running
# -----------------------------------------------------------------------------

name: CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
  TF_IN_AUTOMATION: true

jobs:
  # ---------------------------------------------------------------------------
  # CI + PLAN + COST (runs on PR and push to main)
  # ---------------------------------------------------------------------------
  ci-plan-cost:
    name: CI + Plan + Cost
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t helium-ci:latest .

      - name: Run CI checks (includes plan and cost)
        run: |
          docker run --rm \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e AWS_DEFAULT_REGION \
            -e INFRACOST_API_KEY \
            -v $(pwd):/workspace \
            -w /workspace \
            helium-ci:latest \
            bash -c 'git config --global --add safe.directory /workspace && make ci'

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plans-and-costs
          path: .ci/
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read plan
            const planPath = '.ci/plan/plan-production.txt';
            let plan = 'Plan not found';
            let summary = '';
            
            if (fs.existsSync(planPath)) {
              const fullPlan = fs.readFileSync(planPath, 'utf8');
              
              // Extract summary from plan
              const summaryMatch = fullPlan.match(/Plan: (\d+) to add, (\d+) to change, (\d+) to destroy/);
              if (summaryMatch) {
                const [_, add, change, destroy] = summaryMatch;
                summary = `**üìä Summary:** ${add} to add, ${change} to change, ${destroy} to destroy\n\n`;
              }
              
              // Truncate plan if too long
              const maxLength = 100000;
              plan = fullPlan.slice(0, maxLength);
              if (fullPlan.length > maxLength) {
                plan += '\n\n‚ö†Ô∏è **Plan truncated - download artifacts for full output**';
              }
            }

            // Read production cost
            const costProdPath = '.ci/plan/cost-production.txt';
            const costProd = fs.existsSync(costProdPath)
              ? fs.readFileSync(costProdPath, 'utf8').slice(0, 5000)
              : 'Cost estimate not available';

            // Read staging cost
            const costStagingPath = '.ci/plan/cost-staging.txt';
            const costStaging = fs.existsSync(costStagingPath)
              ? fs.readFileSync(costStagingPath, 'utf8').slice(0, 5000)
              : 'Cost estimate not available';

            const body = `## üìã Terraform Plan
            

\`\`\`hcl
${plan}
\`\`\`
</details>

## üí∞ Cost Estimates

<details><summary>Production</summary>

\`\`\`
${costProd}
\`\`\`
</details>

<details><summary>Staging</summary>

\`\`\`
${costStaging}
\`\`\`
</details>

---
üì¶ [Download full artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            const marker = '<!-- terragrunt-results -->';
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.rest.issues.listComments({
              owner, repo, issue_number
            });

            const existing = comments.data.find(c => c.body && c.body.includes(marker));
            const finalBody = `${marker}\n${body}`;

            if (existing) {
              await github.rest.issues.updateComment({
                owner, repo, comment_id: existing.id, body: finalBody
              });
            } else {
              await github.rest.issues.createComment({
                owner, repo, issue_number, body: finalBody
              });
            }

  # ---------------------------------------------------------------------------
  # APPLY (only runs on merge to main, requires manual approval)
  # COMMENTED OUT - uncomment when ready to enable auto-apply
  # ---------------------------------------------------------------------------
  # apply:
  #   name: Apply Infrastructure
  #   runs-on: ubuntu-latest
  #   needs: ci-plan-cost
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   environment:
  #     name: production
  #
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Build Docker image
  #       run: docker build -t helium-ci:latest .
  #
  #     - name: Apply infrastructure
  #       run: |
  #         docker run --rm \
  #           -e AWS_ACCESS_KEY_ID \
  #           -e AWS_SECRET_ACCESS_KEY \
  #           -e AWS_DEFAULT_REGION \
  #           -v $(pwd):/workspace \
  #           -w /workspace \
  #           helium-ci:latest \
  #           bash -c 'git config --global --add safe.directory /workspace && cd production && terragrunt run --all -- apply -auto-approve'
